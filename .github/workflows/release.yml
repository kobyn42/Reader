name: Release plugin

on:
    push:
        branches:
            - main

permissions:
    contents: write

concurrency:
    group: release-main
    cancel-in-progress: false

jobs:
    release:
        if: github.actor != 'GitHub Actions [bot]'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Resolve next version
              id: next_version
              run: node scripts/next-version.mjs

            - name: Bump plugin versions
              run: NEXT_VERSION="${{ steps.next_version.outputs.version }}" node version-bump.mjs

            - name: Build plugin
              run: npm run build

            - name: Commit and tag release
              env:
                  VERSION: ${{ steps.next_version.outputs.version }}
              run: |
                  git config --global user.email "action@github.com"
                  git config --global user.name "GitHub Actions [bot]"
                  git add manifest.json versions.json
                  git commit -m "chore(release): ${VERSION}"
                  git tag "${VERSION}"
                  git push origin HEAD:main --follow-tags

            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.next_version.outputs.version }}
                  generate_release_notes: true
                  files: |
                      main.js
                      manifest.json
                      styles.css
                  fail_on_unmatched_files: false
